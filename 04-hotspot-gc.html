<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.43">
    <style>
      :root {
        --c-bg: #fff;
      }
      html.dark {
        --c-bg: #22272e;
      }
      html, body {
        background-color: var(--c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme');
			const systemDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
			if (userMode === 'dark' || (userMode !== 'light' && systemDarkMode)) {
				document.documentElement.classList.toggle('dark', true);
			}
    </script>
    <link rel="icon" href="https://avatars.githubusercontent.com/u/43716716?s=200&v=4"><title>HotSpot 垃圾收集器 | JVM 底层原理最全知识总结</title><meta name="description" content="Doocs开源社区">
    <link rel="modulepreload" href="/jvm/assets/app.4d859125.js"><link rel="modulepreload" href="/jvm/assets/04-hotspot-gc.html.caa9f6b6.js"><link rel="modulepreload" href="/jvm/assets/04-hotspot-gc.html.8f824275.js"><link rel="prefetch" href="/jvm/assets/00-quickstart.html.1306bbd7.js"><link rel="prefetch" href="/jvm/assets/01-jvm-memory-structure.html.c617a513.js"><link rel="prefetch" href="/jvm/assets/02-hotspot-jvm-object.html.ced1ee98.js"><link rel="prefetch" href="/jvm/assets/03-gc-algorithms.html.d88c1750.js"><link rel="prefetch" href="/jvm/assets/05-memory-allocation-gc.html.c7e9795e.js"><link rel="prefetch" href="/jvm/assets/06-jvm-performance-tuning.html.4c3cad0b.js"><link rel="prefetch" href="/jvm/assets/07-class-structure.html.0d015252.js"><link rel="prefetch" href="/jvm/assets/08-load-class-time.html.bf3e8bde.js"><link rel="prefetch" href="/jvm/assets/09-load-class-process.html.1c4dc57a.js"><link rel="prefetch" href="/jvm/assets/10-class-loader.html.f86dac01.js"><link rel="prefetch" href="/jvm/assets/index.html.9e257cee.js"><link rel="prefetch" href="/jvm/assets/summary.html.3bb93f75.js"><link rel="prefetch" href="/jvm/assets/404.html.93146c89.js"><link rel="prefetch" href="/jvm/assets/00-quickstart.html.225893d2.js"><link rel="prefetch" href="/jvm/assets/01-jvm-memory-structure.html.d715b04e.js"><link rel="prefetch" href="/jvm/assets/02-hotspot-jvm-object.html.831b5773.js"><link rel="prefetch" href="/jvm/assets/03-gc-algorithms.html.8be3c849.js"><link rel="prefetch" href="/jvm/assets/05-memory-allocation-gc.html.2feee429.js"><link rel="prefetch" href="/jvm/assets/06-jvm-performance-tuning.html.921dad37.js"><link rel="prefetch" href="/jvm/assets/07-class-structure.html.bb3fae97.js"><link rel="prefetch" href="/jvm/assets/08-load-class-time.html.741826e6.js"><link rel="prefetch" href="/jvm/assets/09-load-class-process.html.de7e6f32.js"><link rel="prefetch" href="/jvm/assets/10-class-loader.html.ceaa7c22.js"><link rel="prefetch" href="/jvm/assets/index.html.551cb932.js"><link rel="prefetch" href="/jvm/assets/summary.html.98f85e4f.js"><link rel="prefetch" href="/jvm/assets/404.html.e9e747cc.js"><link rel="prefetch" href="/jvm/assets/404.caf9fb71.js"><link rel="prefetch" href="/jvm/assets/Layout.d5d2a7d6.js">
    <link rel="stylesheet" href="/jvm/assets/style.c6ff1bd2.css">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><!--[--><header class="navbar"><div class="toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a href="/jvm/" class=""><!----><span class="site-name">JVM 底层原理最全知识总结</span></a></span><div class="navbar-items-wrapper" style=""><!--[--><!--]--><!----><!--[--><!--]--><button class="toggle-dark-button" title="toggle dark mode"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><!----></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><!----><!--[--><!--]--><ul class="sidebar-items"><!--[--><li><p tabindex="0" class="sidebar-item sidebar-heading">HotSpot 垃圾收集器 <!----></p><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/jvm/04-hotspot-gc.html#新生代垃圾收集器" class="router-link-active router-link-exact-active sidebar-item" aria-label="新生代垃圾收集器"><!--[--><!--]--> 新生代垃圾收集器 <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/jvm/04-hotspot-gc.html#serial-垃圾收集器-单线程" class="router-link-active router-link-exact-active sidebar-item" aria-label="Serial 垃圾收集器（单线程）"><!--[--><!--]--> Serial 垃圾收集器（单线程） <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/jvm/04-hotspot-gc.html#parnew-垃圾收集器-多线程" class="router-link-active router-link-exact-active sidebar-item" aria-label="ParNew 垃圾收集器（多线程）"><!--[--><!--]--> ParNew 垃圾收集器（多线程） <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/jvm/04-hotspot-gc.html#parallel-scavenge-垃圾收集器-多线程" class="router-link-active router-link-exact-active sidebar-item" aria-label="Parallel Scavenge 垃圾收集器（多线程）"><!--[--><!--]--> Parallel Scavenge 垃圾收集器（多线程） <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a aria-current="page" href="/jvm/04-hotspot-gc.html#老年代垃圾收集器" class="router-link-active router-link-exact-active sidebar-item" aria-label="老年代垃圾收集器"><!--[--><!--]--> 老年代垃圾收集器 <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/jvm/04-hotspot-gc.html#serial-old-垃圾收集器-单线程" class="router-link-active router-link-exact-active sidebar-item" aria-label="Serial Old 垃圾收集器（单线程）"><!--[--><!--]--> Serial Old 垃圾收集器（单线程） <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/jvm/04-hotspot-gc.html#parallel-old-垃圾收集器-多线程" class="router-link-active router-link-exact-active sidebar-item" aria-label="Parallel Old 垃圾收集器（多线程）"><!--[--><!--]--> Parallel Old 垃圾收集器（多线程） <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/jvm/04-hotspot-gc.html#cms-垃圾收集器" class="router-link-active router-link-exact-active sidebar-item" aria-label="CMS 垃圾收集器"><!--[--><!--]--> CMS 垃圾收集器 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a aria-current="page" href="/jvm/04-hotspot-gc.html#g1-通用垃圾收集器" class="router-link-active router-link-exact-active sidebar-item" aria-label="G1 通用垃圾收集器"><!--[--><!--]--> G1 通用垃圾收集器 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><h1 id="hotspot-垃圾收集器" tabindex="-1"><a class="header-anchor" href="#hotspot-垃圾收集器" aria-hidden="true">#</a> HotSpot 垃圾收集器</h1><p>HotSpot 虚拟机提供了多种垃圾收集器，每种收集器都有各自的特点，虽然我们要对各个收集器进行比较，但并非为了挑选出一个最好的收集器。我们选择的只是对具体应用最合适的收集器。</p><h2 id="新生代垃圾收集器" tabindex="-1"><a class="header-anchor" href="#新生代垃圾收集器" aria-hidden="true">#</a> 新生代垃圾收集器</h2><h3 id="serial-垃圾收集器-单线程" tabindex="-1"><a class="header-anchor" href="#serial-垃圾收集器-单线程" aria-hidden="true">#</a> Serial 垃圾收集器（单线程）</h3><p>只开启<strong>一条</strong> GC 线程进行垃圾回收，并且在垃圾收集过程中停止一切用户线程，即 Stop The World。</p><p>一般客户端应用所需内存较小，不会创建太多对象，而且堆内存不大，因此垃圾收集器回收时间短，即使在这段时间停止一切用户线程，也不会感觉明显卡顿。因此 Serial 垃圾收集器<strong>适合客户端</strong>使用。</p><p>由于 Serial 收集器只使用一条 GC 线程，避免了线程切换的开销，从而简单高效。</p><p><img src="https://cdn.jsdelivr.net/gh/doocs/jvm@main/images/serial.png" alt="Serial"></p><h3 id="parnew-垃圾收集器-多线程" tabindex="-1"><a class="header-anchor" href="#parnew-垃圾收集器-多线程" aria-hidden="true">#</a> ParNew 垃圾收集器（多线程）</h3><p>ParNew 是 Serial 的多线程版本。由多条 GC 线程并行地进行垃圾清理。但清理过程依然需要 Stop The World。</p><p>ParNew 追求“<strong>低停顿时间</strong>”,与 Serial 唯一区别就是使用了多线程进行垃圾收集，在多 CPU 环境下性能比 Serial 会有一定程度的提升；但<strong>线程切换需要额外的开销</strong>，因此在单 CPU 环境中表现不如 Serial。</p><p><img src="https://cdn.jsdelivr.net/gh/doocs/jvm@main/images/parnew.png" alt="ParNew"></p><h3 id="parallel-scavenge-垃圾收集器-多线程" tabindex="-1"><a class="header-anchor" href="#parallel-scavenge-垃圾收集器-多线程" aria-hidden="true">#</a> Parallel Scavenge 垃圾收集器（多线程）</h3><p>Parallel Scavenge 和 ParNew 一样，都是多线程、新生代垃圾收集器。但是两者有巨大的不同点：</p><ul><li>Parallel Scavenge：追求 CPU 吞吐量，能够在较短时间内完成指定任务，因此适合没有交互的后台计算。</li><li>ParNew：追求降低用户停顿时间，适合交互式应用。</li></ul><p><code>吞吐量 = 运行用户代码时间 / (运行用户代码时间 + 垃圾收集时间)</code></p><p>追求高吞吐量，可以通过减少 GC 执行实际工作的时间，然而，仅仅偶尔运行 GC 意味着每当 GC 运行时将有许多工作要做，因为在此期间积累在堆中的对象数量很高。单个 GC 需要花更多的时间来完成，从而导致更高的暂停时间。而考虑到低暂停时间，最好频繁运行 GC 以便更快速完成，反过来又导致吞吐量下降。</p><ul><li>通过参数 -XX:GCTimeRadio 设置垃圾回收时间占总 CPU 时间的百分比。</li><li>通过参数 -XX:MaxGCPauseMillis 设置垃圾处理过程最久停顿时间。</li><li>通过命令 -XX:+UseAdaptiveSizePolicy 开启自适应策略。我们只要设置好堆的大小和 MaxGCPauseMillis 或 GCTimeRadio，收集器会自动调整新生代的大小、Eden 和 Survivor 的比例、对象进入老年代的年龄，以最大程度上接近我们设置的 MaxGCPauseMillis 或 GCTimeRadio。</li></ul><h2 id="老年代垃圾收集器" tabindex="-1"><a class="header-anchor" href="#老年代垃圾收集器" aria-hidden="true">#</a> 老年代垃圾收集器</h2><h3 id="serial-old-垃圾收集器-单线程" tabindex="-1"><a class="header-anchor" href="#serial-old-垃圾收集器-单线程" aria-hidden="true">#</a> Serial Old 垃圾收集器（单线程）</h3><p>Serial Old 收集器是 Serial 的老年代版本，都是单线程收集器，只启用一条 GC 线程，都适合客户端应用。它们唯一的区别就是：Serial Old 工作在老年代，使用“标记-整理”算法；Serial 工作在新生代，使用“复制”算法。</p><h3 id="parallel-old-垃圾收集器-多线程" tabindex="-1"><a class="header-anchor" href="#parallel-old-垃圾收集器-多线程" aria-hidden="true">#</a> Parallel Old 垃圾收集器（多线程）</h3><p>Parallel Old 收集器是 Parallel Scavenge 的老年代版本，追求 CPU 吞吐量。</p><h3 id="cms-垃圾收集器" tabindex="-1"><a class="header-anchor" href="#cms-垃圾收集器" aria-hidden="true">#</a> CMS 垃圾收集器</h3><p>CMS（Concurrent Mark Sweep，并发标记清除）收集器是以获取最短回收停顿时间为目标的收集器（追求低停顿），它在垃圾收集时使得用户线程和 GC 线程并发执行，因此在垃圾收集过程中用户也不会感到明显的卡顿。</p><ul><li>初始标记：Stop The World，仅使用一条初始标记线程对所有与 GC Roots 直接关联的对象进行标记。</li><li>并发标记：使用<strong>多条</strong>标记线程，与用户线程并发执行。此过程进行可达性分析，标记出所有废弃对象。速度很慢。</li><li>重新标记：Stop The World，使用多条标记线程并发执行，将刚才并发标记过程中新出现的废弃对象标记出来。</li><li>并发清除：只使用一条 GC 线程，与用户线程并发执行，清除刚才标记的对象。这个过程非常耗时。</li></ul><p>并发标记与并发清除过程耗时最长，且可以与用户线程一起工作，因此，<strong>总体上说</strong>，CMS 收集器的内存回收过程是与用户线程<strong>一起并发执行</strong>的。</p><p><img src="https://cdn.jsdelivr.net/gh/doocs/jvm@main/images/cms.png" alt="CMS"></p><p>CMS 的缺点：</p><ul><li>吞吐量低</li><li>无法处理浮动垃圾</li><li>使用“标记-清除”算法产生碎片空间，导致频繁 Full GC</li></ul><p>对于产生碎片空间的问题，可以通过开启 -XX:+UseCMSCompactAtFullCollection，在每次 Full GC 完成后都会进行一次内存压缩整理，将零散在各处的对象整理到一块。设置参数 -XX:CMSFullGCsBeforeCompaction 告诉 CMS，经过了 N 次 Full GC 之后再进行一次内存整理。</p><h2 id="g1-通用垃圾收集器" tabindex="-1"><a class="header-anchor" href="#g1-通用垃圾收集器" aria-hidden="true">#</a> G1 通用垃圾收集器</h2><p>G1 是一款面向服务端应用的垃圾收集器，它没有新生代和老年代的概念，而是将堆划分为一块块独立的 Region。当要进行垃圾收集时，首先估计每个 Region 中垃圾的数量，每次都从垃圾回收价值最大的 Region 开始回收，因此可以获得最大的回收效率。</p><p>从整体上看， G1 是基于“标记-整理”算法实现的收集器，从局部（两个 Region 之间）上看是基于“复制”算法实现的，这意味着运行期间不会产生内存空间碎片。</p><p>这里抛个问题 👇</p><blockquote><p>一个对象和它内部所引用的对象可能不在同一个 Region 中，那么当垃圾回收时，是否需要扫描整个堆内存才能完整地进行一次可达性分析？</p></blockquote><p>并不！每个 Region 都有一个 Remembered Set，用于记录本区域中所有对象引用的对象所在的区域，进行可达性分析时，只要在 GC Roots 中再加上 Remembered Set 即可防止对整个堆内存进行遍历。</p><p>如果不计算维护 Remembered Set 的操作，G1 收集器的工作过程分为以下几个步骤：</p><ul><li>初始标记：Stop The World，仅使用一条初始标记线程对所有与 GC Roots 直接关联的对象进行标记。</li><li>并发标记：使用<strong>一条</strong>标记线程与用户线程并发执行。此过程进行可达性分析，速度很慢。</li><li>最终标记：Stop The World，使用多条标记线程并发执行。</li><li>筛选回收：回收废弃对象，此时也要 Stop The World，并使用多条筛选回收线程并发执行。</li></ul><!--]--></div><footer class="page-meta"><!----><div class="meta-item last-updated"><span class="meta-item-label">Last Updated: </span><!----></div><div class="meta-item contributors"><span class="meta-item-label">Contributors: </span><span class="meta-item-info"><!--[--><!--[--><span class="contributor" title="email: szuyanglb@outlook.com">yanglbme</span><!--[-->, <!--]--><!--]--><!--[--><span class="contributor" title="email: 51509297+linnanc@users.noreply.github.com">linnan</span><!--[-->, <!--]--><!--]--><!--[--><span class="contributor" title="email: yanglbme@users.noreply.github.com">yanglbme</span><!--[-->, <!--]--><!--]--><!--[--><span class="contributor" title="email: szuyanglb@outlook.com">杨立滨</span><!----><!--]--><!--]--></span></div></footer><!----><!--[--><!--]--></main><!--]--></div><!----><!--]--></div>
    <script type="module" src="/jvm/assets/app.4d859125.js" defer></script>
  </body>
</html>
